<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReadLater - Daha Sonra Oku</title>
  <meta name="description" content="Makalelerinizi kaydedin, daha sonra okuyun">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <style>
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .tab-btn {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-size: 0.95rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: var(--text-secondary);
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-count {
      background: var(--bg-tertiary);
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      font-size: 0.75rem;
      margin-left: 0.5rem;
    }

    .top-nav {
      position: sticky;
      top: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      z-index: 100;
      margin: -3rem -2rem 2rem -2rem;
      width: calc(100% + 4rem);
    }

    .brand {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .brand:hover {
      color: var(--accent);
    }

    .refresh-btn {
      padding: 0.5rem 1rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .refresh-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .search-box {
      margin-bottom: 1rem;
    }

    .search-box input {
      width: 100%;
      padding: 0.8rem 1.2rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 30px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow), var(--shadow-md);
      background: var(--bg-tertiary);
    }

    .search-box input::placeholder {
      color: var(--text-muted);
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Ãœst Navbar -->
    <nav class="top-nav">
      <a href="/" class="brand">ğŸ“– Reader</a>
      <div style="display: flex; gap: 0.5rem;">
        <button class="refresh-btn" onclick="downloadBackup()" title="Yedek indir">ğŸ’¾ Yedek</button>
        <button class="refresh-btn" onclick="triggerRestore()" title="Yedekten geri yÃ¼kle">ğŸ“¥ YÃ¼kle</button>
        <button class="refresh-btn" onclick="refreshAll()">ğŸ”„ Yenile</button>
        <input type="file" id="restoreFileInput" accept=".json" style="display: none;"
          onchange="handleRestoreFile(event)">
      </div>
    </nav>

    <header>
      <h1>ğŸ“– ReadLater</h1>
      <p class="subtitle">Makalelerinizi kaydedin, daha sonra okuyun</p>
    </header>

    <!-- URL Ekleme Formu -->
    <section class="add-form">
      <form id="addForm">
        <input type="url" id="urlInput" placeholder="Makale URL'sini buraya yapÄ±ÅŸtÄ±rÄ±n..." required autocomplete="off">
        <button type="submit" id="submitBtn">
          <span class="btn-text">ğŸ’¾ Kaydet</span>
          <span class="btn-loading" hidden>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" stroke-opacity="0.25" />
              <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round">
                <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
                  repeatCount="indefinite" />
              </path>
            </svg>
          </span>
        </button>
      </form>
      <div id="message" class="message" hidden></div>
    </section>

    <!-- Arama -->
    <div class="search-box">
      <input type="search" id="searchInput" placeholder="ğŸ” Makalelerde ara..." autocomplete="off">
    </div>

    <!-- Tab MenÃ¼sÃ¼ -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="articles">
        ğŸ“š Makaleler <span class="tab-count" id="articlesCount">0</span>
      </button>
      <button class="tab-btn" data-tab="archive">
        ğŸ“¦ ArÅŸiv <span class="tab-count" id="archiveCount">0</span>
      </button>
    </div>

    <!-- Makale Listesi -->
    <section class="articles">
      <div id="articleList" class="article-list">
        <div class="loading">YÃ¼kleniyor</div>
      </div>
    </section>
  </div>

  <script>
    // URL'yi otomatik belirle
    let currentTab = 'articles';

    // SayfayÄ± yenile
    async function refreshAll() {
      invalidateCache();
      await loadArticles();
    }

    // Tab deÄŸiÅŸtirme
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTab = btn.dataset.tab;
        searchQuery = '';
        document.getElementById('searchInput').value = '';
        loadArticles();
      });
    });

    // Arama
    let searchQuery = '';
    let searchTimeout = null;
    document.getElementById('searchInput').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchQuery = e.target.value.toLowerCase().trim();
        loadArticles();
      }, 300);
    });

    // Makale listesini yÃ¼kle
    async function loadArticles() {
      const listEl = document.getElementById('articleList');
      const endpoint = currentTab === 'archive' ? '/api/archived' : '/api/articles';

      try {
        // Tamamen relatif path kullan (baÅŸÄ±nda / ile)
        const res = await fetch(`${endpoint}?t=${Date.now()}`, {
          credentials: 'omit'
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();

        if (!data.success) {
          throw new Error(data.error || 'API HatasÄ±');
        }

        // SayÄ±larÄ± gÃ¼ncelle
        updateCounts();

        // YanÄ±t baÅŸarÄ±sÄ±zsa hata gÃ¶ster
        if (!data.success) {
          throw new Error(data.error || 'Veriler alÄ±namadÄ±');
        }

        // Arama filtresi uygula
        let articles = data.articles || [];
        if (searchQuery) {
          articles = articles.filter(a =>
            (a.title && a.title.toLowerCase().includes(searchQuery)) ||
            (a.site_name && a.site_name.toLowerCase().includes(searchQuery)) ||
            (a.excerpt && a.excerpt.toLowerCase().includes(searchQuery))
          );
        }

        if (articles.length === 0) {
          const emptyMsg = searchQuery
            ? `"${searchQuery}" iÃ§in sonuÃ§ bulunamadÄ±`
            : (currentTab === 'archive' ? 'ArÅŸivde makale yok' : 'HenÃ¼z kayÄ±tlÄ± makale yok');
          listEl.innerHTML = `
            <div class="empty">
              <div style="font-size: 3rem; margin-bottom: 1rem;">${searchQuery ? 'ğŸ”' : (currentTab === 'archive' ? 'ğŸ“¦' : 'ğŸ“­')}</div>
              <p>${emptyMsg}</p>
            </div>
          `;
          return;
        }

        listEl.innerHTML = articles.map((article, index) => `
          <article class="article-card ${article.error ? 'has-error' : ''} ${article.read_at ? 'is-read' : ''}" style="animation-delay: ${index * 0.05}s">
            <div class="article-content">
              <h3>
                <a href="/read/${article.id}">${escapeHtml(article.title || 'BaÅŸlÄ±ksÄ±z')}</a>
              </h3>
              <div class="article-meta">
                ${article.site_name ? `<span class="site">${escapeHtml(article.site_name)}</span>` : ''}
                <span class="date">ğŸ“… ${formatDate(article.saved_at)}</span>
                ${article.read_at ? '<span class="read-badge">âœ“ Okundu</span>' : ''}
              </div>
              ${article.excerpt ? `<p class="excerpt">${escapeHtml(article.excerpt.substring(0, 180))}...</p>` : ''}
              ${article.error ? `<div class="error-info">âš ï¸ ${escapeHtml(article.error)}</div>` : ''}
            </div>
            <div class="article-actions">
              <a href="${article.url}" target="_blank" class="btn-link" title="Orijinal sayfayÄ± aÃ§">ğŸ”—</a>
              <button data-action="copy" data-url="${article.url}" title="URL'yi kopyala">ğŸ“‹</button>
              ${article.read_at && currentTab !== 'archive'
            ? `<button data-action="unread" data-id="${article.id}" title="OkunmadÄ± olarak iÅŸaretle">ğŸ”„</button>`
            : ''
          }
              ${currentTab === 'archive'
            ? `<button data-action="unarchive" data-id="${article.id}" title="ArÅŸivden Ã§Ä±kar">ğŸ“¤</button>`
            : `<button data-action="archive" data-id="${article.id}" title="ArÅŸive taÅŸÄ±">ğŸ“¦</button>`
          }
              <button data-action="delete" data-id="${article.id}" class="btn-delete" title="Makaleyi sil">ğŸ—‘ï¸</button>
            </div>
          </article>
        `).join('');

      } catch (error) {
        console.error('YÃ¼kleme hatasÄ±:', error);
        listEl.innerHTML = `
          <div class="error-state">
            <p>ğŸ”´ <strong>BaÄŸlantÄ± HatasÄ±</strong></p>
            <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
              Detay: ${error.message}<br>
              Adres: ${window.location.host}${endpoint}
            </p>
            <button onclick="location.reload()" style="margin-top: 10px; padding: 5px 15px; border-radius: 5px; border: 1px solid #ccc; background: #f0f0f0; cursor: pointer;">Tekrar Dene</button>
            <button onclick="testConnection()" style="margin-top: 10px; padding: 5px 15px; border-radius: 5px; border: 1px solid #007bff; background: #007bff; color: white; cursor: pointer;">AÄŸÄ± Test Et</button>
          </div>
        `;
      }
    }

    // Basit aÄŸ testi
    async function testConnection() {
      try {
        const start = Date.now();
        const res = await fetch('/health?t=' + start, { credentials: 'omit' });
        const time = Date.now() - start;
        const text = await res.text();
        alert(`âœ… BAÄLANTI BAÅARILI!\nUzaklÄ±k: ${time}ms\nYanÄ±t: ${text.substring(0, 50)}`);
      } catch (error) {
        alert(`âŒ BAÄLANTI HATASI!\nDetay: ${error.message}\nSunucuya hiÃ§ ulaÅŸÄ±lamÄ±yor. LÃ¼tfen VPN/Firewall kontrol edin.`);
      }
    }

    // SayÄ±larÄ± gÃ¼ncelle (cache ile optimize)
    let articlesCache = null;
    let archiveCache = null;

    async function updateCounts() {
      try {
        // EÄŸer cache yoksa API'den al
        if (articlesCache === null) {
          const articlesRes = await fetch(`/api/articles?t=${Date.now()}`, { credentials: 'omit' });
          const data = await articlesRes.json();
          articlesCache = data.articles?.length || 0;
        }
        if (archiveCache === null) {
          const archiveRes = await fetch(`/api/archived?t=${Date.now()}`, { credentials: 'omit' });
          const data = await archiveRes.json();
          archiveCache = data.articles?.length || 0;
        }

        document.getElementById('articlesCount').textContent = articlesCache;
        document.getElementById('archiveCount').textContent = archiveCache;
      } catch (error) {
        console.error('SayÄ±lar gÃ¼ncellenemedi:', error);
      }
    }

    // Cache'i invalidate et (makale ekle/sil/arÅŸivle sonrasÄ±)
    function invalidateCache() {
      articlesCache = null;
      archiveCache = null;
    }

    // URL kaydet
    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const urlInput = document.getElementById('urlInput');
      const submitBtn = document.getElementById('submitBtn');
      const messageEl = document.getElementById('message');
      const url = urlInput.value.trim();

      if (!url) return;

      submitBtn.querySelector('.btn-text').hidden = true;
      submitBtn.querySelector('.btn-loading').hidden = false;
      submitBtn.disabled = true;
      messageEl.hidden = true;

      try {
        const res = await fetch(`/api/save`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const data = await res.json();

        if (data.success) {
          showMessage('âœ… ' + (data.article?.title || 'Makale baÅŸarÄ±yla kaydedildi!'), 'success');
          urlInput.value = '';
          invalidateCache();
          loadArticles();
        } else if (data.exists) {
          showMessage('â„¹ï¸ Bu makale zaten kayÄ±tlÄ±: ' + (data.article?.title || ''), 'info');
        } else {
          showMessage('âŒ ' + data.error, 'error');
        }

      } catch (error) {
        showMessage('âŒ BaÄŸlantÄ± hatasÄ±: ' + error.message, 'error');
      } finally {
        submitBtn.querySelector('.btn-text').hidden = false;
        submitBtn.querySelector('.btn-loading').hidden = true;
        submitBtn.disabled = false;
      }
    });

    // Event delegation for article actions
    document.getElementById('articleList').addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const action = btn.dataset.action;
      const id = btn.dataset.id;
      const url = btn.dataset.url;

      switch (action) {
        case 'archive':
          await archiveArticle(id);
          break;
        case 'unarchive':
          await unarchiveArticle(id);
          break;
        case 'unread':
          await unmarkAsRead(id);
          break;
        case 'delete':
          await deleteArticle(id);
          break;
        case 'copy':
          await copyToClipboard(url);
          break;
      }
    });

    // OkunmadÄ± iÅŸaretle
    async function unmarkAsRead(id) {
      try {
        const res = await fetch(`/api/article/${id}/unread`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showMessage('ğŸ”„ Makale okunmadÄ± olarak iÅŸaretlendi', 'success');
          loadArticles();
        } else {
          showMessage('Hata: ' + data.error, 'error');
        }
      } catch (error) {
        showMessage('BaÄŸlantÄ± hatasÄ±: ' + error.message, 'error');
      }
    }

    // ArÅŸive taÅŸÄ±
    async function archiveArticle(id) {
      try {
        const res = await fetch(`/api/article/${id}/archive`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showMessage('ğŸ“¦ Makale arÅŸive taÅŸÄ±ndÄ±', 'success');
          invalidateCache();
          loadArticles();
        } else {
          showMessage('Hata: ' + data.error, 'error');
        }
      } catch (error) {
        showMessage('BaÄŸlantÄ± hatasÄ±: ' + error.message, 'error');
      }
    }

    // ArÅŸivden Ã§Ä±kar
    async function unarchiveArticle(id) {
      try {
        const res = await fetch(`/api/article/${id}/unarchive`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showMessage('ğŸ“¤ Makale arÅŸivden Ã§Ä±karÄ±ldÄ±', 'success');
          invalidateCache();
          loadArticles();
        } else {
          showMessage('Hata: ' + data.error, 'error');
        }
      } catch (error) {
        showMessage('BaÄŸlantÄ± hatasÄ±: ' + error.message, 'error');
      }
    }

    // Makale sil
    async function deleteArticle(id) {
      if (!confirm('Bu makaleyi kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?')) return;

      try {
        const res = await fetch(`/api/article/${id}`, { method: 'DELETE' });
        const data = await res.json();

        if (data.success) {
          showMessage('ğŸ—‘ï¸ Makale silindi', 'success');
          invalidateCache();
          loadArticles();
        } else {
          showMessage('Silme hatasÄ±: ' + data.error, 'error');
        }
      } catch (error) {
        showMessage('BaÄŸlantÄ± hatasÄ±: ' + error.message, 'error');
      }
    }

    // URL kopyala
    async function copyToClipboard(url) {
      try {
        await navigator.clipboard.writeText(url);
        showMessage('ğŸ“‹ URL kopyalandÄ±!', 'success');
      } catch (error) {
        showMessage('Kopyalama hatasÄ±: ' + error.message, 'error');
      }
    }

    // Mesaj gÃ¶ster
    function showMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `message ${type}`;
      messageEl.hidden = false;

      setTimeout(() => {
        messageEl.hidden = true;
      }, 5000);
    }

    // YardÄ±mcÄ± fonksiyonlar
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;

      if (diff < 86400000 && date.getDate() === now.getDate()) {
        return 'BugÃ¼n ' + date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
      }

      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      if (date.getDate() === yesterday.getDate()) {
        return 'DÃ¼n ' + date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
      }

      return date.toLocaleDateString('tr-TR', {
        day: 'numeric',
        month: 'short',
        year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
      });
    }

    // === BACKUP / RESTORE ===

    // Yedek indir
    async function downloadBackup() {
      try {
        showMessage('ğŸ’¾ Yedek hazÄ±rlanÄ±yor...', 'info');
        const res = await fetch(`/api/backup`);
        const blob = await res.blob();

        // Dosya olarak indir
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `readlater-backup-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();

        showMessage('âœ… Yedek indirildi!', 'success');
      } catch (error) {
        showMessage('âŒ Yedekleme hatasÄ±: ' + error.message, 'error');
      }
    }

    // Geri yÃ¼kleme dosya seÃ§iciyi tetikle
    function triggerRestore() {
      document.getElementById('restoreFileInput').click();
    }

    // Geri yÃ¼kleme dosyasÄ±nÄ± iÅŸle
    async function handleRestoreFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Mod seÃ§imi
      const mode = confirm('Mevcut verileri koruyarak eklemek iÃ§in "Tamam", tÃ¼m verileri deÄŸiÅŸtirmek iÃ§in "Ä°ptal" tÄ±klayÄ±n.') ? 'merge' : 'replace';

      if (mode === 'replace') {
        if (!confirm('âš ï¸ DÄ°KKAT: TÃ¼m mevcut veriler silinecek! Devam etmek istiyor musunuz?')) {
          event.target.value = '';
          return;
        }
      }

      try {
        showMessage('ğŸ“¥ Geri yÃ¼kleme baÅŸlatÄ±lÄ±yor...', 'info');

        const text = await file.text();
        const backup = JSON.parse(text);

        const res = await fetch(`/api/restore`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ backup, mode })
        });

        const data = await res.json();

        if (data.success) {
          showMessage(`âœ… Geri yÃ¼kleme tamamlandÄ±! ${data.imported} makale eklendi, ${data.skipped} atlandÄ±.`, 'success');
          invalidateCache();
          loadArticles();
        } else {
          showMessage('âŒ Geri yÃ¼kleme hatasÄ±: ' + data.error, 'error');
        }
      } catch (error) {
        showMessage('âŒ Dosya okunamadÄ± veya geÃ§ersiz format: ' + error.message, 'error');
      }

      // Input'Ä± temizle
      event.target.value = '';
    }

    // Sayfa yÃ¼klendiginde
    loadArticles();
  </script>
</body>

</html>