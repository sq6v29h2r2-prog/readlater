<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okuma - ReadLater</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <style>
        /* Kontrol gruplarƒ± */
        .reader-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }

        .control-group label {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }

        .ctrl-btn {
            min-width: 32px;
            height: 32px;
            padding: 0 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ctrl-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .ctrl-btn:active {
            transform: scale(0.9) !important;
            background: var(--accent-glow) !important;
        }

        .ctrl-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        /* --- Mobile Optimizations --- */
        @media (max-width: 640px) {
            .reader-nav {
                padding: 0.5rem !important;
                flex-direction: column;
                gap: 0.5rem;
            }

            .reader-controls {
                justify-content: center;
                gap: 0.5rem;
                width: 100%;
            }

            .ctrl-btn {
                min-width: 44px;
                /* Touch target minimum */
                height: 44px;
                font-size: 0.9rem;
            }

            .theme-btn {
                width: 32px;
                height: 32px;
            }

            .control-group label {
                display: none;
                /* Alan tasarrufu */
            }
        }

        /* Font butonlarƒ± */
        .font-btn[data-font="helvetica"] {
            font-family: Helvetica, Arial, sans-serif;
        }

        .font-btn[data-font="georgia"] {
            font-family: Georgia, serif;
        }

        .font-btn[data-font="avenir"] {
            font-family: 'Avenir Next', Avenir, sans-serif;
        }

        .size-display {
            min-width: 28px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        /* Font sƒ±nƒ±flarƒ± - Recursive Force specificity */
        .reader-body.font-helvetica,
        .reader-body.font-helvetica * {
            font-family: Helvetica, Arial, sans-serif !important;
        }

        .reader-body.font-georgia,
        .reader-body.font-georgia * {
            font-family: Georgia, 'Times New Roman', serif !important;
        }

        .reader-body.font-avenir,
        .reader-body.font-avenir * {
            font-family: 'Avenir Next', Avenir, 'Segoe UI', sans-serif !important;
        }

        /* Font Size Enforcement */
        .reader-body {
            --reader-font-size: 18px;
            --reader-line-height: 1.6;
        }

        .reader-body,
        .reader-body p,
        .reader-body div,
        .reader-body span,
        .reader-body li {
            font-size: var(--reader-font-size) !important;
            line-height: var(--reader-line-height) !important;
        }

        .reader-body h1,
        .reader-body h2 {
            font-size: calc(var(--reader-font-size) * 1.5) !important;
        }

        .reader-body h3,
        .reader-body h4 {
            font-size: calc(var(--reader-font-size) * 1.2) !important;
        }

        /* Geni≈ülik modlarƒ± - Force specificity */
        .reader-content.width-narrow {
            max-width: 600px !important;
        }

        .reader-content.width-normal {
            max-width: 720px !important;
        }

        .reader-content.width-wide {
            max-width: 900px !important;
        }

        /* Mobile Specific Width Adjustments */
        @media (max-width: 600px) {
            .reader-content {
                padding-left: 1.5rem !important;
                padding-right: 1.5rem !important;
            }

            .reader-content.width-narrow {
                padding-left: 2.5rem !important;
                padding-right: 2.5rem !important;
            }

            .reader-content.width-wide {
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }
        }

        /* === TEMA SE√áENEKLERƒ∞ === */

        /* Siyah Tema */
        body.theme-black {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #1a1a1a;
            --bg-glass: rgba(0, 0, 0, 0.9);
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-muted: #707070;
            --border: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(255, 255, 255, 0.2);
        }

        /* Gri Tema (varsayƒ±lan) */
        body.theme-gray {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-glass: rgba(13, 17, 23, 0.9);
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --border: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(255, 255, 255, 0.15);
        }

        /* Sepya Tema */
        body.theme-sepia {
            --bg-primary: #f4ecd8;
            --bg-secondary: #efe6d0;
            --bg-tertiary: #e5dcc8;
            --bg-glass: rgba(244, 236, 216, 0.95);
            --text-primary: #5b4636;
            --text-secondary: #7a6652;
            --text-muted: #998b77;
            --border: rgba(91, 70, 54, 0.15);
            --border-hover: rgba(91, 70, 54, 0.25);
        }

        /* Beyaz Tema */
        body.theme-white {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --bg-glass: rgba(255, 255, 255, 0.95);
            --text-primary: #1a1a1a;
            --text-secondary: #495057;
            --text-muted: #868e96;
            --border: rgba(0, 0, 0, 0.1);
            --border-hover: rgba(0, 0, 0, 0.2);
        }

        /* Tema butonlarƒ± */
        .theme-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-btn:hover {
            transform: scale(1.1);
        }

        .theme-btn:active {
            transform: scale(0.8) !important;
        }

        .theme-btn.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .theme-btn[data-theme="black"] {
            background: #000000;
        }

        .theme-btn[data-theme="gray"] {
            background: #0d1117;
        }

        .theme-btn[data-theme="sepia"] {
            background: #f4ecd8;
        }

        .theme-btn[data-theme="white"] {
            background: #ffffff;
        }

        /* Highlight stilleri */
        /* Multi-color Highlights */
        .highlight {
            padding: 0.1em 0;
            border-radius: 2px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .highlight.hl-yellow {
            background: rgba(255, 226, 0, 0.4);
        }

        .highlight.hl-green {
            background: rgba(52, 211, 153, 0.4);
        }

        .highlight.hl-blue {
            background: rgba(96, 165, 250, 0.4);
        }

        .highlight.hl-pink {
            background: rgba(244, 114, 182, 0.4);
        }

        .highlight:hover {
            filter: brightness(1.1);
        }

        /* Highlight popup */
        .highlight-popup {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 6px 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .highlight-popup.visible {
            display: flex;
        }

        .hl-color-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .hl-color-btn:hover {
            transform: scale(1.2);
        }

        .hl-color-btn.yellow {
            background: #ffe200;
        }

        .hl-color-btn.green {
            background: #34d399;
        }

        .hl-color-btn.blue {
            background: #60a5fa;
        }

        .hl-color-btn.pink {
            background: #f472b6;
        }

        .hl-sep {
            width: 1px;
            height: 20px;
            background: var(--border);
            margin: 0 4px;
        }

        .hl-delete-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0 4px;
            font-size: 1.1rem;
        }

        .hl-delete-btn:hover {
            color: var(--error);
        }

        /* Highlight modu g√∂stergesi */
        .highlight-mode-indicator {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: #ffe600;
            color: #000;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            display: none;
            z-index: 100;
        }

        .highlight-mode-indicator.visible {
            display: block;
        }

        /* Not paneli */
        .notes-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            z-index: 200;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .notes-panel.open {
            right: 0;
        }

        .notes-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notes-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .notes-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .notes-content {
            flex: 1;
            padding: 1rem;
        }

        .notes-textarea {
            width: 100%;
            height: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            padding: 1rem;
            resize: none;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .notes-status {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: right;
        }

        /* Tam ekran modu */
        body.fullscreen-mode .reader-nav {
            display: none;
        }

        body.fullscreen-mode .reader-content {
            padding-top: 2rem;
        }

        /* Fullscreen g√∂stergesi */
        .fullscreen-hint {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.3s;
        }

        body.fullscreen-mode .fullscreen-hint {
            opacity: 1;
        }

        @media (max-width: 500px) {
            .notes-panel {
                width: 100%;
                right: -100%;
            }
        }

        /* Toast Message */
        .toast {
            position: fixed;
            bottom: 3rem;
            left: 50%;
            transform: translateX(-50%) translateY(120px);
            background: var(--accent);
            color: white;
            padding: 0.8rem 1.6rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 20px var(--accent-glow);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body class="reader-page">
    <nav class="reader-nav">
        <a href="/" class="back-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            Geri
        </a>

        <div class="reader-controls">
            <!-- Yazƒ± Tipi -->
            <div class="control-group">
                <label>Yazƒ±:</label>
                <button class="ctrl-btn font-btn active" data-font="helvetica">Helvetica</button>
                <button class="ctrl-btn font-btn" data-font="georgia">Georgia</button>
                <button class="ctrl-btn font-btn" data-font="avenir">Avenir Next</button>
            </div>

            <!-- Yazƒ± Boyutu -->
            <div class="control-group">
                <label>Boyut:</label>
                <button class="ctrl-btn" id="sizeDown">‚àí</button>
                <span class="size-display" id="sizeDisplay">18</span>
                <button class="ctrl-btn" id="sizeUp">+</button>
            </div>

            <!-- Geni≈ülik -->
            <div class="control-group">
                <label>Geni≈ülik:</label>
                <button class="ctrl-btn" id="widthNarrow" title="Dar">S</button>
                <button class="ctrl-btn active" id="widthNormal" title="Normal">M</button>
                <button class="ctrl-btn" id="widthWide" title="Geni≈ü">L</button>
            </div>

            <!-- Tema -->
            <div class="control-group">
                <label>Tema:</label>
                <button class="theme-btn" data-theme="black" title="Siyah"></button>
                <button class="theme-btn active" data-theme="gray" title="Gri"></button>
                <button class="theme-btn" data-theme="sepia" title="Sepya"></button>
                <button class="theme-btn" data-theme="white" title="Beyaz"></button>
            </div>

            <!-- Highlight -->
            <div class="control-group">
                <button class="ctrl-btn" id="highlightToggle" title="Highlight Modu">üñçÔ∏è</button>
            </div>

            <!-- Notlar -->
            <div class="control-group">
                <button class="ctrl-btn" id="notesToggle" title="Notlar">üìù</button>
            </div>

            <!-- Tam Ekran -->
            <div class="control-group">
                <button class="ctrl-btn" id="fullscreenToggle" title="Tam Ekran (F)">‚õ∂</button>
            </div>
        </div>

        <div class="reader-actions">
            <a id="originalLink" href="#" target="_blank" title="Orijinal">üîó</a>
            <button id="unreadBtn" title="Okunmadƒ± Olarak ƒ∞≈üaretle">üîÑ</button>
            <button id="archiveBtn" title="Ar≈üive Ta≈üƒ±">üì¶</button>
            <button id="deleteBtn" title="Sil">üóëÔ∏è</button>
        </div>
    </nav>

    <!-- Highlight Popup -->
    <div class="highlight-popup" id="highlightPopup">
        <button class="hl-color-btn yellow" data-color="yellow" title="Sarƒ±"></button>
        <button class="hl-color-btn green" data-color="green" title="Ye≈üil"></button>
        <button class="hl-color-btn blue" data-color="blue" title="Mavi"></button>
        <button class="hl-color-btn pink" data-color="pink" title="Pembe"></button>
        <div class="hl-sep"></div>
        <button class="hl-delete-btn" id="closePopupBtn" title="Kapat">‚úï</button>
    </div>

    <!-- Highlight G√∂stergesi -->
    <div class="highlight-mode-indicator" id="highlightIndicator">üñçÔ∏è Highlight Modu - Metin se√ßin</div>

    <!-- Fullscreen G√∂stergesi -->
    <div class="fullscreen-hint">F tu≈üu ile √ßƒ±k</div>

    <!-- Not Paneli -->
    <aside class="notes-panel" id="notesPanel">
        <div class="notes-header">
            <h3>üìù Notlarƒ±m</h3>
            <button class="notes-close" id="notesClose">√ó</button>
        </div>
        <div class="notes-content">
            <textarea class="notes-textarea" id="notesTextarea"
                placeholder="Bu makale hakkƒ±nda notlarƒ±nƒ±zƒ± yazƒ±n..."></textarea>
        </div>
        <div class="notes-status" id="notesStatus"></div>
    </aside>

    <!-- Toast Message Container -->
    <!-- Toast Message Container -->
    <div id="toast" class="toast">‚úì Ayar kaydedildi</div>

    <article class="reader-content width-normal" id="readerContent">
        <header class="reader-header">
            <h1 id="articleTitle">Y√ºkleniyor...</h1>
            <div class="reader-meta">
                <span id="articleAuthor"></span>
                <span id="articleSite"></span>
                <span id="articleDate"></span>
            </div>
        </header>

        <div id="articleBody" class="reader-body font-helvetica"
            style="--reader-font-size: 18px; transition: font-family 0.3s ease, font-size 0.3s ease;">
            <div class="loading">ƒ∞√ßerik y√ºkleniyor</div>
        </div>
    </article>

    <script>
        const articleId = window.location.pathname.split('/').filter(Boolean).pop();
        if (!articleId || isNaN(articleId)) {
            console.error('Makale ID tespit edilemedi!');
        }
        const articleBody = document.getElementById('articleBody');
        const readerContent = document.getElementById('readerContent');
        const highlightPopup = document.getElementById('highlightPopup');
        const highlightIndicator = document.getElementById('highlightIndicator');
        const notesPanel = document.getElementById('notesPanel');
        const notesTextarea = document.getElementById('notesTextarea');
        const notesStatus = document.getElementById('notesStatus');

        let highlightMode = false;
        let notesSaveTimeout = null;

        // === TOAST FEEDBACK ===
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerHTML = `<span>‚úì</span> ${message}`;
            toast.classList.add('visible');

            // Haptic feedback (if supported)
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(20);
            }

            setTimeout(() => toast.classList.remove('visible'), 2000);
        }

        // === FONT SE√áƒ∞Cƒ∞ ===
        const fontBtns = document.querySelectorAll('.font-btn');
        setFont(localStorage.getItem('readlater-font') || 'helvetica', false);

        fontBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                setFont(btn.dataset.font, true);
                localStorage.setItem('readlater-font', btn.dataset.font);
            });
        });

        function setFont(font, notify = true) {
            fontBtns.forEach(b => b.classList.remove('active'));
            document.querySelector(`.font-btn[data-font="${font}"]`)?.classList.add('active');
            articleBody.classList.remove('font-helvetica', 'font-georgia', 'font-avenir');
            articleBody.classList.add(`font-${font}`);
            if (notify) showToast('Yazƒ± tipi deƒüi≈ütirildi');
        }

        // === YAZI BOYUTU ===
        let fontSize = parseInt(localStorage.getItem('readlater-size')) || 18;
        const sizeDisplay = document.getElementById('sizeDisplay');
        setFontSize(fontSize);

        document.getElementById('sizeDown').addEventListener('click', () => {
            if (fontSize > 12) { fontSize -= 2; setFontSize(fontSize, true); localStorage.setItem('readlater-size', fontSize); }
        });
        document.getElementById('sizeUp').addEventListener('click', () => {
            if (fontSize < 32) { fontSize += 2; setFontSize(fontSize, true); localStorage.setItem('readlater-size', fontSize); }
        });

        function setFontSize(size, notify = false) {
            articleBody.style.setProperty('--reader-font-size', size + 'px');
            articleBody.style.setProperty('--reader-line-height', (1.4 + (size / 100))); // Dinamik satƒ±r arasƒ±
            sizeDisplay.textContent = size;
            if (notify) showToast('Yazƒ± boyutu g√ºncellendi');
        }

        // === GENƒ∞≈ûLƒ∞K MODU (D√úZELTƒ∞LDƒ∞) ===
        const widthBtns = { narrow: document.getElementById('widthNarrow'), normal: document.getElementById('widthNormal'), wide: document.getElementById('widthWide') };
        setWidth(localStorage.getItem('readlater-width') || 'normal');

        Object.entries(widthBtns).forEach(([mode, btn]) => {
            btn.addEventListener('click', () => { setWidth(mode, true); localStorage.setItem('readlater-width', mode); });
        });

        function setWidth(mode, notify = false) {
            Object.values(widthBtns).forEach(b => b.classList.remove('active'));
            widthBtns[mode]?.classList.add('active');
            readerContent.classList.remove('width-narrow', 'width-normal', 'width-wide');
            readerContent.classList.add(`width-${mode}`);
            if (notify) showToast('Geni≈ülik g√ºncellendi');
        }

        // === TEMA SE√áƒ∞Cƒ∞ ===
        const themeBtns = document.querySelectorAll('.theme-btn');
        const savedTheme = localStorage.getItem('readlater-theme') || 'gray';
        setTheme(savedTheme);

        themeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.dataset.theme;
                setTheme(theme, true);
                localStorage.setItem('readlater-theme', theme);
            });
        });

        function setTheme(theme, notify = false) {
            themeBtns.forEach(b => b.classList.remove('active'));
            document.querySelector(`.theme-btn[data-theme="${theme}"]`)?.classList.add('active');
            document.body.classList.remove('theme-black', 'theme-gray', 'theme-sepia', 'theme-white');
            document.body.classList.add(`theme-${theme}`);
            if (notify) showToast('Tema deƒüi≈ütirildi');
        }

        // === TAM EKRAN MODU ===
        const fullscreenToggle = document.getElementById('fullscreenToggle');

        fullscreenToggle.addEventListener('click', toggleFullscreen);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'f' || e.key === 'F') {
                if (e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                    toggleFullscreen();
                }
            }
            if (e.key === 'Escape') {
                document.body.classList.remove('fullscreen-mode');
                fullscreenToggle.classList.remove('active');
            }
        });

        function toggleFullscreen() {
            document.body.classList.toggle('fullscreen-mode');
            fullscreenToggle.classList.toggle('active');
        }

        // === HIGHLIGHT MODU ===
        const highlightToggle = document.getElementById('highlightToggle');

        highlightToggle.addEventListener('click', () => {
            highlightMode = !highlightMode;
            highlightToggle.classList.toggle('active', highlightMode);
            highlightIndicator.classList.toggle('visible', highlightMode);
        });

        // Helper: Highlight renk paletini g√∂ster
        function showColorPalette(selection, e = null) {
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();

            // Eƒüer event parametresi varsa (saƒü tƒ±k), mouse pozisyonuna daha yakƒ±n yapabiliriz 
            // ama genel se√ßim √ºst√ºnde durmasƒ± daha ≈üƒ±k
            highlightPopup.style.left = (rect.left + window.scrollX + (rect.width / 2) - 80) + 'px';
            highlightPopup.style.top = (rect.top + window.scrollY - 50) + 'px';
            highlightPopup.classList.add('visible');

            // Renk butonlarƒ±na listener ekle
            document.querySelectorAll('.hl-color-btn').forEach(btn => {
                btn.onclick = async (ev) => {
                    ev.stopPropagation();
                    await addHighlight(selection, btn.dataset.color);
                    highlightPopup.classList.remove('visible');
                };
            });

            document.getElementById('closePopupBtn').onclick = () => {
                highlightPopup.classList.remove('visible');
                selection.removeAllRanges();
            };
        }

        // Mouse bƒ±rakƒ±nca (Eƒüer mod a√ßƒ±ksa otomatik g√∂ster)
        document.addEventListener('mouseup', (e) => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (selectedText.length > 0 && highlightMode && articleBody.contains(selection.anchorNode)) {
                showColorPalette(selection);
            } else if (!highlightPopup.contains(e.target)) {
                highlightPopup.classList.remove('visible');
            }
        });

        // SAƒû TIK ile Highlight Modunu Tetikle (Mod kapalƒ± olsa bile √ßalƒ±≈üƒ±r)
        document.addEventListener('contextmenu', (e) => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (selectedText.length > 0 && articleBody.contains(selection.anchorNode)) {
                e.preventDefault(); // Standart saƒü tƒ±k men√ºs√ºn√º engelle
                showColorPalette(selection, e);

                // Eƒüer mod kapalƒ±ysa otomatik a√ßabiliriz (isteƒüe baƒülƒ±)
                if (!highlightMode) {
                    highlightMode = true;
                    highlightToggle.classList.add('active');
                    highlightIndicator.classList.add('visible');
                }
            }
        });

        async function addHighlight(selection, color = 'yellow') {
            const text = selection.toString().trim();
            if (!text) return;

            try {
                const range = selection.getRangeAt(0);
                const res = await fetch(`/api/article/${articleId}/highlight`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, color })
                });

                const data = await res.json();
                if (data.success) {
                    const span = document.createElement('span');
                    span.className = `highlight hl-${color}`;
                    span.dataset.hlId = data.highlight?.id;
                    span.textContent = text;
                    range.deleteContents();
                    range.insertNode(span);
                    selection.removeAllRanges();

                    // Yeni eklenen highlight'a silme listener'ƒ± ekle
                    span.onclick = () => {
                        if (confirm('Bu vurgulamayƒ± silmek ister misiniz?')) deleteHighlight(span.dataset.hlId, span);
                    };
                } else {
                    alert('Highlight kaydedilirken bir hata olu≈ütu.');
                }
            } catch (error) {
                console.error('Highlight kaydedilemedi:', error);
                alert('Highlight kaydedilemedi: Sunucu hatasƒ±');
            }
        }

        function applyHighlights(highlights) {
            if (!highlights || highlights.length === 0) return;
            let html = articleBody.innerHTML;

            // Highlightlarƒ± metin uzunluƒüuna g√∂re sƒ±rala (i√ß i√ße ge√ßmemesi i√ßin b√ºy√ºkten k√º√ß√ºƒüe)
            const sorted = [...highlights].sort((a, b) => b.text.length - a.text.length);

            sorted.forEach(hl => {
                if (hl.text) {
                    const escaped = hl.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const colorClass = `hl-${hl.color || 'yellow'}`;
                    // Sadece metin d√ºƒü√ºmlerinde (text nodes) deƒüi≈üiklik yapmak en g√ºvenlisidir ama ≈üimdilik iyile≈ütirilmi≈ü regex kullanalƒ±m
                    // Daha √∂nce deƒüi≈ütirilmi≈ü olanlarƒ± bozmamak i√ßin negatif lookahead/lookbehind gerekebilir
                    const regex = new RegExp(`(${escaped})(?![^<]*>|[^<>]*<\/span>)`, 'g');
                    html = html.replace(regex, `<span class="highlight ${colorClass}" data-hl-id="${hl.id}">$1</span>`);
                }
            });
            articleBody.innerHTML = html;

            document.querySelectorAll('.highlight').forEach(el => {
                el.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm('Bu vurgulamayƒ± silmek ister misiniz?')) deleteHighlight(el.dataset.hlId, el);
                };
            });
        }

        async function deleteHighlight(hlId, element) {
            try {
                const res = await fetch(`/api/article/${articleId}/highlight/${hlId}`, { method: 'DELETE' });
                if ((await res.json()).success && element) element.replaceWith(element.textContent);
            } catch (error) { console.error('Highlight silinemedi:', error); }
        }

        // === NOTLAR ===
        const notesToggle = document.getElementById('notesToggle');
        const notesClose = document.getElementById('notesClose');

        notesToggle.addEventListener('click', () => {
            notesPanel.classList.toggle('open');
            notesToggle.classList.toggle('active');
        });
        notesClose.addEventListener('click', () => {
            notesPanel.classList.remove('open');
            notesToggle.classList.remove('active');
        });

        notesTextarea.addEventListener('input', () => {
            notesStatus.textContent = 'Kaydediliyor...';
            clearTimeout(notesSaveTimeout);
            notesSaveTimeout = setTimeout(saveNotes, 1000);
        });

        async function saveNotes() {
            try {
                const res = await fetch(`/api/article/${articleId}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes: notesTextarea.value })
                });
                if ((await res.json()).success) {
                    notesStatus.textContent = '‚úì Kaydedildi';
                    setTimeout(() => { notesStatus.textContent = ''; }, 2000);
                }
            } catch (error) { notesStatus.textContent = '‚ùå Hata'; }
        }

        // === OKUNMADI ===
        document.getElementById('unreadBtn').addEventListener('click', async () => {
            try {
                const res = await fetch(`/api/article/${articleId}/unread`, { method: 'POST' });
                if ((await res.json()).success) {
                    alert('Makale okunmadƒ± olarak i≈üaretlendi');
                    window.location.href = '/';
                }
            } catch (error) { alert('Hata: ' + error.message); }
        });

        // === AR≈ûƒ∞V ===
        document.getElementById('archiveBtn').addEventListener('click', async () => {
            if (!confirm('Bu makaleyi ar≈üive ta≈üƒ±mak istiyor musunuz?')) return;
            try {
                const res = await fetch(`/api/article/${articleId}/archive`, { method: 'POST' });
                if ((await res.json()).success) window.location.href = '/';
            } catch (error) { alert('Hata: ' + error.message); }
        });

        // === Sƒ∞L ===
        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (!confirm('Bu makaleyi kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?')) return;
            try {
                const res = await fetch(`/api/article/${articleId}`, { method: 'DELETE' });
                if ((await res.json()).success) window.location.href = '/';
            } catch (error) { alert('Hata: ' + error.message); }
        });

        // === MAKALE Y√úKLE ===
        async function loadArticle() {
            try {
                const res = await fetch(`/api/article/${articleId}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                const article = data.article;
                document.getElementById('articleTitle').textContent = article.title || 'Ba≈ülƒ±ksƒ±z';
                document.title = (article.title || 'Makale') + ' - ReadLater';

                if (article.author) document.getElementById('articleAuthor').innerHTML = `‚úçÔ∏è ${article.author}`;
                if (article.site_name) document.getElementById('articleSite').innerHTML = `üåê ${article.site_name}`;
                if (article.saved_at) {
                    const date = new Date(article.saved_at);
                    document.getElementById('articleDate').innerHTML = `üìÖ ${date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' })}`;
                }

                document.getElementById('originalLink').href = article.url;

                if (article.content) {
                    articleBody.innerHTML = article.content;
                    setFont(localStorage.getItem('readlater-font') || 'helvetica', false);
                    setFontSize(parseInt(localStorage.getItem('readlater-size')) || 18, false);
                    if (article.highlights?.length > 0) applyHighlights(article.highlights);
                } else if (article.error) {
                    articleBody.innerHTML = `<div class="error-box"><h3>‚ö†Ô∏è ƒ∞√ßerik alƒ±namadƒ±</h3><p>${article.error}</p><p><a href="${article.url}" target="_blank">Orijinal sayfayƒ± ziyaret edin ‚Üí</a></p></div>`;
                } else {
                    articleBody.innerHTML = '<div class="error">ƒ∞√ßerik bulunamadƒ±</div>';
                }

                // Notlarƒ± y√ºkle
                if (article.notes) notesTextarea.value = article.notes;

            } catch (error) {
                articleBody.innerHTML = `<div class="error-box"><h3>‚ùå Hata</h3><p>${error.message}</p></div>`;
            }
        }

        loadArticle();
    </script>
</body>

</html>